editors:
  - version: trunk
packages:
  - name: Core
    id: core
    packagename: com.unity.render-pipelines.core
    dependencies:
      - .yamato/upm-ci-packages.yml#pack_core
  - name: Lightweight
    id: lwrp
    packagename: com.unity.render-pipelines.lightweight
    dependencies:
      - .yamato/upm-ci-packages.yml#pack_core
      - .yamato/upm-ci-packages.yml#pack_shadergraph
      - .yamato/upm-ci-packages.yml#pack_lightweight
    hascodependencies: 1
  - name: ShaderGraph
    id: shadergraph
    packagename: com.unity.shadergraph
    dependencies:
      - .yamato/upm-ci-packages.yml#pack_core
      - .yamato/upm-ci-packages.yml#pack_shadergraph
    hascodependencies: 1
  - name: HDRP
    id: hdrp
    packagename: com.unity.render-pipelines.high-definition
    dependencies:
      - .yamato/upm-ci-packages.yml#pack_core
      - .yamato/upm-ci-packages.yml#pack_shadergraph
      - .yamato/upm-ci-packages.yml#pack_vfx
      - .yamato/upm-ci-packages.yml#pack_hdrp
    hascodependencies: 1
  - name: VFXMain
    id: vfx
    packagename: com.unity.visualeffectgraph
    dependencies:
      - .yamato/upm-ci-packages.yml#pack_vfx
platforms:
    - name: win
      agent:
        type: Unity::VM
        image: package-ci/win10:stable
        flavor: b1.large
      copycmd: copy upm-ci~\packages\*.tgz .Editor\Data\Resources\PackageManager\Editor
      editorpath: .\.Editor
    - name: mac
      agent:
        type: Unity::VM::osx
        image: buildfarm/mac:stable
        flavor: m1.mac
      copycmd: cp ./upm-ci~/packages/*.tgz ./.Editor/Unity.app/Contents/Resources/PackageManager/Editor
      editorpath: $HOME/.Editor
---
{% for package in packages %}
pack_{{ package.id }}:
  name: z_(do not use) Pack {{ package.name }}
  agent:
    type: Unity::VM
    image: package-ci/win10:stable
    flavor: b1.large
  commands:
    - npm install upm-ci-utils@stable -g --registry https://api.bintray.com/npm/unity/unity-npm
    - upm-ci package pack --package-path {{ package.packagename }}
  artifacts:
    packages:
      paths:
        - "upm-ci~/packages/**/*"
{% endfor %}

<<<<<<< HEAD
=======
pack_shadergraph_package:
  name: z_(do not use) Pack shadergraph
  agent:
    type: Unity::VM
    image: package-ci/win10:stable
    flavor: b1.large
  commands:
    - npm install upm-ci-utils@stable -g --registry https://api.bintray.com/npm/unity/unity-npm
    - upm-ci package pack --package-path com.unity.shadergraph
  dependencies:
  {% for editor in editors %}
    - .yamato/upm-ci-packages.yml#test_core_package_{{ editor.version }}
  {% endfor %}
  artifacts:
    packages:
      paths:
        - "upm-ci~/packages/**/*"

{% for editor in editors %}
test_shadergraph_package_{{ editor.version }}:
  name: z_(do not use) Test shadergraph
  agent:
    type: Unity::VM
    image: package-ci/win10:stable
    flavor: b1.large
  commands:
    - dir
    - dir upm-ci~
    - dir upm-ci~\\packages
    - npm install upm-ci-utils@stable -g --registry https://api.bintray.com/npm/unity/unity-npm
    - pip install unity-downloader-cli --extra-index-url https://artifactory.eu-cph-1.unityops.net/api/pypi/common-python/simple
    - unity-downloader-cli -u {{ editor.version }} -c editor --wait
    - copy upm-ci~\packages\*.tgz .Editor\Data\Resources\PackageManager\Editor
    - dir .\.Editor\Data\Resources\PackageManager\Editor
    - upm-ci package test -u .\.Editor --package-path com.unity.shadergraph
  dependencies:
    - .yamato/upm-ci-packages.yml#pack_core_package
    - .yamato/upm-ci-packages.yml#pack_shadergraph_package
  artifacts:
    logs:
      paths:
        - "upm-ci~/test-results/**/*"
{% endfor %}

pack_lightweight_package:
  name: z_(do not use) Pack lightweight
  agent:
    type: Unity::VM
    image: package-ci/win10:stable
    flavor: b1.large
  commands:
    - npm install upm-ci-utils@stable -g --registry https://api.bintray.com/npm/unity/unity-npm
    - upm-ci package pack --package-path com.unity.render-pipelines.lightweight
  dependencies:
  {% for editor in editors %}
    - .yamato/upm-ci-packages.yml#test_universal_package_{{ editor.version }}
  {% endfor %}
  artifacts:
    packages:
      paths:
        - "**/upm-ci~/packages/**/*"

>>>>>>> packages-yamato
{% for editor in editors %}
{% for platform in platforms %}
{% for package in packages %}
test_{{ package.id }}_{{ platform.name }}_{{ editor.version }}:
  name: z_(do not use) Test {{ package.name }} {{ platform.name }} {{ editor.version }}
  agent:
    type: {{ platform.agent.type }}
    image: {{ platform.agent.image }}
    flavor: {{ platform.agent.flavor }}
  commands:
    #- npm install upm-ci-utils@stable -g --registry https://api.bintray.com/npm/unity/unity-npm
    - git clone --single-branch --branch base-0.13.0/win-short-path git@github.cds.internal.unity3d.com:unity/upm-ci-utils.git ../upm-ci-utils
    - npm install -g ../upm-ci-utils
    {% if package.hascodependencies %}
    - pip install unity-downloader-cli --extra-index-url https://artifactory.eu-cph-1.unityops.net/api/pypi/common-python/simple
    - unity-downloader-cli -u {{ editor.version }} -c editor --wait
<<<<<<< HEAD
    - {{ platform.copycmd }}
    - upm-ci package test -u {{ platform.editorpath }} --package-path {{ package.packagename }}
    {% else %}
    - upm-ci package test -u {{ editor.version }} --package-path {{ package.packagename }}
    {% endif %}
=======
    - copy upm-ci~\packages\*.tgz .Editor\Data\Resources\PackageManager\Editor
    - upm-ci package test -u .\.Editor --package-path com.unity.render-pipelines.lightweight
  dependencies:
    - .yamato/upm-ci-packages.yml#pack_universal_package
    - .yamato/upm-ci-packages.yml#pack_lightweight_package
  artifacts:
    logs:
      paths:
        - "**/upm-ci~/test-results/**/*"
{% endfor %}

pack_universal_package:
  name: z_(do not use) Pack universal
  agent:
    type: Unity::VM
    image: package-ci/win10:stable
    flavor: b1.large
  commands:
    - npm install upm-ci-utils@stable -g --registry https://api.bintray.com/npm/unity/unity-npm
    - upm-ci package pack --package-path com.unity.render-pipelines.universal
  dependencies:
  {% for editor in editors %}
    - .yamato/upm-ci-packages.yml#test_core_package_{{ editor.version }}
    - .yamato/upm-ci-packages.yml#test_shadergraph_package_{{ editor.version }}
  {% endfor %}
  artifacts:
    packages:
      paths:
        - "**/upm-ci~/packages/**/*"
        
{% for editor in editors %}
test_universal_package_{{ editor.version }}:
  name: z_(do not use) Test universal {{ editor.version }}
  agent:
    type: Unity::VM
    image: package-ci/win10:stable
    flavor: b1.large
  commands:
    - npm install upm-ci-utils@stable -g --registry https://api.bintray.com/npm/unity/unity-npm
    - pip install unity-downloader-cli --extra-index-url https://artifactory.eu-cph-1.unityops.net/api/pypi/common-python/simple
    - unity-downloader-cli -u {{ editor.version }} -c editor --wait
    - copy upm-ci~\packages\*.tgz .Editor\Data\Resources\PackageManager\Editor
    - upm-ci package test -u .\.Editor --package-path com.unity.render-pipelines.universal
  dependencies:
    - .yamato/upm-ci-packages.yml#pack_core_package
    - .yamato/upm-ci-packages.yml#pack_shadergraph_package
    - .yamato/upm-ci-packages.yml#pack_universal_package
>>>>>>> packages-yamato
  artifacts:
    logs:
      paths:
        - "**/upm-ci~/test-results/**/*"
<<<<<<< HEAD
=======
{% endfor %}

pack_hdrp_package:
  name: z_(do not use) Pack hdrp
  agent:
    type: Unity::VM
    image: package-ci/win10:stable
    flavor: b1.large
  commands:
    - npm install upm-ci-utils@stable -g --registry https://api.bintray.com/npm/unity/unity-npm
    - upm-ci package pack --package-path com.unity.render-pipelines.high-definition
  dependencies:
  {% for editor in editors %}
    - .yamato/upm-ci-packages.yml#test_core_package_{{ editor.version }}
    - .yamato/upm-ci-packages.yml#test_shadergraph_package_{{ editor.version }}
    - .yamato/upm-ci-packages.yml#test_vfx_package_{{ editor.version }}
  {% endfor %}
  artifacts:
    packages:
      paths:
        - "**/upm-ci~/packages/**/*"

{% for editor in editors %}
test_hdrp_package_{{ editor.version }}:
  name: z_(do not use) Test hdrp {{ editor.version }}
  agent:
    type: Unity::VM
    image: package-ci/win10:stable
    flavor: b1.large
  commands:
    - npm install upm-ci-utils@stable -g --registry https://api.bintray.com/npm/unity/unity-npm
    - pip install unity-downloader-cli --extra-index-url https://artifactory.eu-cph-1.unityops.net/api/pypi/common-python/simple
    - unity-downloader-cli -u {{ editor.version }} -c editor --wait
    - copy upm-ci~\packages\*.tgz .Editor\Data\Resources\PackageManager\Editor
    - upm-ci package test -u .\.Editor --package-path com.unity.render-pipelines.high-definition
>>>>>>> packages-yamato
  dependencies:
    {% for dep in package.dependencies %}
    - {{ dep }}
    {% endfor %}
{% endfor %}
{% endfor %}
{% endfor %}

pack_hdconfig_package:
  name: z_(do not use) Pack HD_Config
  agent:
    type: Unity::VM
    image: package-ci/win10:stable
    flavor: b1.large
  commands:
    - npm install upm-ci-utils@stable -g --registry https://api.bintray.com/npm/unity/unity-npm
    - upm-ci package pack --package-path com.unity.render-pipelines.high-definition-config
  artifacts:
    packages:
      paths:
        - "upm-ci~/packages/**/*"

{% for editor in editors %}
test_hdconfig_package_{{ editor.version }}:
  name: z_(do not use) Test HD_Config {{ editor.version }}
  agent:
    type: Unity::VM
    image: package-ci/win10:stable
    flavor: b1.large
  commands:
    - npm install upm-ci-utils@stable -g --registry https://api.bintray.com/npm/unity/unity-npm
    - upm-ci package test -u {{ editor.version }} --package-path com.unity.render-pipelines.high-definition-config
  artifacts:
    logs:
      paths:
        - "**/upm-ci~/test-results/**/*"
  dependencies:
    - .yamato/upm-ci-packages.yml#pack_hdconfig_package
{% endfor %}

all_package_ci:
  name: Pack and test all packages
  agent:
    type: Unity::VM
    image: package-ci/win10:stable
    flavor: b1.large
  dependencies:
{% for editor in editors %}
{% for platform in platforms %}
{% for package in packages %}
    - .yamato/upm-ci-packages.yml#test_{{ package.id}}_{{ platform.name }}_{{ editor.version }}
{% endfor %}
{% endfor %}
{% endfor %}

publish_all:
  name: Publish all packages
  agent:
    type: Unity::VM
    image: package-ci/win10:stable
    flavor: b1.large
  commands:
  - npm install upm-ci-utils@stable -g --registry https://api.bintray.com/npm/unity/unity-npm
{% for package in projects %}
  - upm-ci package publish --package-path {{ package.packagename }}
{% endfor %}
  artifacts:
    artifacts:
      paths:
        - "upm-ci~/packages/*.tgz"
  dependencies:
  - .yamato/upm-ci-packages.yml#all_package_ci
  
publish_no_test:
  name: z_(Do not use) Publish all packages
  agent:
    type: Unity::VM
    image: package-ci/win10:stable
    flavor: b1.large
  artifacts:
    artifacts:
      paths:
        - "upm-ci~/packages/*.tgz"
  dependencies:
  - .yamato/upm-ci-packages.yml#publish_core
  - .yamato/upm-ci-packages.yml#publish_universal
  - .yamato/upm-ci-packages.yml#publish_lightweight
  - .yamato/upm-ci-packages.yml#publish_shadergraph
  - .yamato/upm-ci-packages.yml#publish_hdrp
  - .yamato/upm-ci-packages.yml#publish_hd_config
  - .yamato/upm-ci-packages.yml#publish_vfx
  
publish_core:
  name: z_(Do not use) Publish core
  agent:
    type: Unity::VM
    image: package-ci/win10:stable
    flavor: b1.large
  commands:
  - npm install upm-ci-utils@stable -g --registry https://api.bintray.com/npm/unity/unity-npm
  - upm-ci package publish --package-path com.unity.render-pipelines.core
  artifacts:
    artifacts:
      paths:
        - "upm-ci~/packages/*.tgz"
  dependencies:
  - .yamato/upm-ci-packages.yml#pack_core_package
  
publish_universal:
  name: z_(Do not use) Publish universal
  agent:
    type: Unity::VM
    image: package-ci/win10:stable
    flavor: b1.large
  commands:
  - npm install upm-ci-utils@stable -g --registry https://api.bintray.com/npm/unity/unity-npm
  - upm-ci package publish --package-path com.unity.render-pipelines.universal
  artifacts:
    artifacts:
      paths:
        - "upm-ci~/packages/*.tgz"
  dependencies:
  - .yamato/upm-ci-packages.yml#pack_universal_package
  
publish_lightweight:
  name: z_(Do not use) Publish lightweight
  agent:
    type: Unity::VM
    image: package-ci/win10:stable
    flavor: b1.large
  commands:
  - npm install upm-ci-utils@stable -g --registry https://api.bintray.com/npm/unity/unity-npm
  - upm-ci package publish --package-path com.unity.render-pipelines.lightweight
  artifacts:
    artifacts:
      paths:
        - "upm-ci~/packages/*.tgz"
  dependencies:
  - .yamato/upm-ci-packages.yml#pack_lightweight_package
  
publish_shadergraph:
  name: z_(Do not use) Publish shadergraph
  agent:
    type: Unity::VM
    image: package-ci/win10:stable
    flavor: b1.large
  commands:
  - npm install upm-ci-utils@stable -g --registry https://api.bintray.com/npm/unity/unity-npm
  - upm-ci package publish --package-path com.unity.shadergraph
  artifacts:
    artifacts:
      paths:
        - "upm-ci~/packages/*.tgz"
  dependencies:
  - .yamato/upm-ci-packages.yml#pack_shadergraph_package
  
publish_hdrp:
  name: z_(Do not use) Publish hdrp
  agent:
    type: Unity::VM
    image: package-ci/win10:stable
    flavor: b1.large
  commands:
  - npm install upm-ci-utils@stable -g --registry https://api.bintray.com/npm/unity/unity-npm
  - upm-ci package publish --package-path com.unity.render-pipelines.high-definition
  artifacts:
    artifacts:
      paths:
        - "upm-ci~/packages/*.tgz"
  dependencies:
  - .yamato/upm-ci-packages.yml#pack_hdrp_package
  
publish_hd_config:
  name: z_(Do not use) Publish hd_config
  agent:
    type: Unity::VM
    image: package-ci/win10:stable
    flavor: b1.large
  commands:
  - npm install upm-ci-utils@stable -g --registry https://api.bintray.com/npm/unity/unity-npm
  - upm-ci package publish --package-path com.unity.render-pipelines.high-definition-config
  artifacts:
    artifacts:
      paths:
        - "upm-ci~/packages/*.tgz"
  dependencies:
  - .yamato/upm-ci-packages.yml#pack_hdconfig_package
  
publish_vfx:
  name: z_(Do not use) Publish vfx
  agent:
    type: Unity::VM
    image: package-ci/win10:stable
    flavor: b1.large
  commands:
  - npm install upm-ci-utils@stable -g --registry https://api.bintray.com/npm/unity/unity-npm
  - upm-ci package publish --package-path com.unity.visualeffectgraph
  artifacts:
    artifacts:
      paths:
        - "upm-ci~/packages/*.tgz"
  dependencies:
  - .yamato/upm-ci-packages.yml#pack_vfx_package